<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="d-flex align-items-center justify-content-start">
    <!-- <h4 class="mr-3 mb-0"><a class="text-dark" (click)="navigateBack()"><i class="fa fa-arrow-left"></i></a></h4> -->
    <h1 class="page-title mb-0">Device Order List</h1>
  </div>
</div>
<div class="row d-flex">
  <div class="d-flex align-items-end col-lg-12 col-sm-12">
    <div class="flex-grow-1">
        <label for="searchBy">Search</label>
        <div class="d-flex align-items-center justify-content-start">
          <input type="text" #searchPatient [(ngModel)]="searchOrdersStr"  autocomplete="off" appOnDebounce [debounceTime]="1500"
          (onDebounce)="getOrdersList()"
          class="form-control form-control-sm box-shadow w-100" id="searchBy" placeholder="Search" />
        </div>
    </div>
    <div class="form-group mb-0" style="min-width: 160px;">
      <ng-select  class="ng-select-small ml-2" [multiple]="false" [searchable]="true"  placeholder="Order No." [clearable]=false>
        <ng-option [value]="">Order No.</ng-option>
        <ng-option [value]="">Customer Name</ng-option>
        <!-- <ng-option [value]="">SKU</ng-option>
        <ng-option [value]="">Line Item</ng-option> -->
    </ng-select>
    </div>
    <button *hasClaim="['IsAppAdmin']" routerLink="/rpm/new-device-order" type="button" class="btn btn-dynamic-2c btn-sm my-0 flex-shrink-0 mr-0">
        Create Order
    </button>
  </div>
</div>
<div *ngIf="gettingSMOrders" class="d-flex justify-content-center text-center">
  <!-- <div class="d-flex justify-content-center text-center"> -->
  <mdb-progress-bar class="progress primary-color-dark mb-0" mode="indeterminate"></mdb-progress-bar>
</div>
<div class="mt-3">
  <ngx-datatable
    #myTable
    class="material fullscreen"
    [columnMode]="'force'"
    [headerHeight]="50"
    [footerHeight]="40"
    [rowHeight]="40"
    [scrollbarV]="false"
    [rows]="ordersList"
    [limit]="15"
    [offset]="0"
    [count]="ordersList?.length"
    [loadingIndicator]=""
    [scrollbarH]="true">
          <!-- Column Templates -->
      <ngx-datatable-column name="Order Number" prop="orderNumber">

      </ngx-datatable-column>
      <ngx-datatable-column name="Customer Name" prop="customerName">
      </ngx-datatable-column>
      <ngx-datatable-column *hasClaim="['IsAppAdmin']" name="Facility Name" prop="facilityName">
      </ngx-datatable-column>
      <ngx-datatable-column name="Created Date" prop="createdOn">
          <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
            <span>{{row.createdOn | date}}</span>
          </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column *hasClaim="['IsAppAdmin']" name="Order Status" prop="orderStatus" [maxWidth]="100" >
        <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
          <!-- <span>{{orderStatusEnum[row.orderStatus]}}</span> -->
          <div class="w-100 d-flex justify-content-center">
            <span *ngIf="row.orderStatus == 5 || row.orderStatus == 8 || row.orderStatus == 6" style="min-width: 80px;"
              class="m-auto badge  badge-info">{{orderStatusEnum[row.orderStatus]}}</span>
            <span *ngIf="row.orderStatus == 4 || row.orderStatus == 9" style="min-width: 80px;"
              class="m-auto badge  badge-danger">{{orderStatusEnum[row.orderStatus]}}</span>
            <span *ngIf="row.orderStatus == 3 || row.orderStatus == 7" style="min-width: 80px;"
              class="m-auto badge  badge-success">{{orderStatusEnum[row.orderStatus]}}</span>
            <span *ngIf="row.orderStatus == 2" style="min-width: 80px;"
              class="m-auto badge  badge-info">{{orderStatusEnum[row.orderStatus]}}</span>
            <span *ngIf="row.orderStatus == 1" style="min-width: 80px;"
              class="m-auto badge  badge-warning">{{orderStatusEnum[row.orderStatus]}}</span>
            <span *ngIf="row.orderStatus == 0" style="min-width: 80px;"
              class="m-auto badge  badge-primary">{{orderStatusEnum[row.orderStatus]}}</span>
          </div>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column *hasClaim="['IsFacilityUser']" name="Order Status" prop="status" [maxWidth]="100" >
        <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
          <div class="w-100 d-flex justify-content-center">
            <span *ngIf="row.orderStatus === 0 || row.orderStatus === 5 || row.orderStatus === 6 || row.orderStatus === 2 " style="min-width: 80px;"
              class="m-auto badge  badge-info">{{row.status}}</span>
              <span *ngIf="row.orderStatus === 1" style="min-width: 80px;"
                class="m-auto badge  badge-warning">{{row.status}}</span>
            <span *ngIf="row.orderStatus === 8 || row.orderStatus === 9" style="min-width: 80px;"
              class="m-auto badge  badge-danger">{{row.status}}</span>
              <span *ngIf="row.orderStatus === 3 || row.orderStatus === 4 || row.orderStatus === 7" style="min-width: 80px;"
              class="m-auto badge  badge-primary">{{row.status}}</span>
          </div>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column name="Notes" prop="notes">
      </ngx-datatable-column>
      <ngx-datatable-column *hasClaim="['IsAppAdmin']" name="Action" >
        <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
          <button type="button" class="btn btn-icon btn-dynamic-2c ml-2" title="View Order Details"
          (click)="GetOrderDetails(row, viewOrderDetailModal)"><i class="fa fa-check-circle-o cursor-pointer"></i></button>
          <!-- <button type="button" title="Mark as completed" class="btn btn-icon btn-info ml-2" [disabled]="isDeletingOrder ||row.orderStatus == orderStatusEnum['Cancelled'] || row.orderStatus == orderStatusEnum['Closed']"
          (click)="openChangeStatusConfirmModal(row)"><i class="fa fa-check-circle-o cursor-pointer"></i></button> -->
          <button type="button" title="Cancel Order"  class="btn btn-icon btn-danger ml-2" [disabled]="isDeletingOrder || row.orderStatus !== orderStatusEnum['In Process']"
          (click)="openConfirmModal(row)"><i class="fa fa-times cursor-pointer"></i></button>
        </ng-template>
      </ngx-datatable-column>
      <!-- <ngx-datatable-column name="Action">
      </ngx-datatable-column> -->
  </ngx-datatable>
</div>



<div mdbModal #viewOrderDetailModal="mdbModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myviewOrderDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Order Details</h5>
        <button type="button" class="close pull-right" aria-label="Close" (click)="viewOrderDetailModal.hide()">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">

          <div class="col-md-4">
            <p><strong>Order Number: </strong>{{preserverOrder?.orderNumber}}</p>
          </div>
          <div class="col-md-4">
            <p><strong>Customer Name: </strong>{{preserverOrder?.customerName}}</p>
          </div>
          <div class="col-md-4">
            <p><strong>Facility Name: </strong>{{preserverOrder?.facilityName}}</p>
          </div>
          <div class="col-md-4">
            <p><strong>Shipping Method: </strong>{{orderDetailObj?.order?.shipping_method}}</p>
          </div>
          <div class="col-md-4">
            <p><strong>Tracking No: </strong></p>
            <p class="tracking" title="Track" (click)="openTracking(item)" *ngFor="let item of trackingNumberList">{{item}}</p>
          </div>
          <div class="col-md-12">
            <p>{{orderDetailObj?.order?.notes || 'No Data'}}</p>
          </div>
          <div class="col-md-8">
            <p><span class="text-danger"> Last Updated: {{orderDetailObj?.order?.last_updated | dateFormatPipe: 'time'}}</span></p>
          </div>
          <div class="col-md-4">
            <div class="custom-control custom-checkbox w-info-90 mx-1">
              <input type="checkbox" class="custom-control-input" [(ngModel)]="showOnlyValidLines"
                id="cpt1">
              <label class="custom-control-label" for="cpt1">Show Devices With Serial</label>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="bg-dynamic-2c text-white">
              <tr>
                <th>SKU</th>
                <th>Serial</th>
                <th>Lot</th>
                <th>Part No.</th>
                <th>UDC</th>
                <th>Qty</th>
                <th>Modal</th>
                <th>IMEI</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let item of orderDetailObj?.order?.lines">
                <tr *ngIf="!showOnlyValidLines || item.serial_number">
                  <td>{{item.sku}}</td>
                  <td>{{item.serial_number}}</td>
                  <td>{{item.lot_number}}</td>
                  <td>{{item.part_number}}</td>
                  <td>{{item.udc_number}}</td>
                  <td>{{item.qty}}</td>
                  <td>{{item.device_model}}</td>
                  <td>{{item.imei}}</td>
                  <td>
                    <button [disabled]="receivingOrder" *ngIf="item.serial_number && !item.addedToInventory" type="button" class="btn btn-info py-1 px-2 btn-sm" title="Add device to Inventory" (click)="ConfirmAddDeviceToInventory(item)">
                      <!-- <span *ngIf="receivingOrder" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> -->
                       Mark As Received</button>
                       <span *ngIf="item.addedToInventory" style="min-width: 80px;" class="badge px-3 badge-success m-0 mr-2">
                        Received
                      </span>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </div>
        <div class="modal-footer" [class.justify-content-between]="preserverOrder.customerType===CustomerTypeEnum.Patient">
          <div class="d-flex align-items-center mb-2">
            <div class="custom-control custom-checkbox w-info-90 mx-1"  *ngIf="preserverOrder.customerType===CustomerTypeEnum.Patient">
              <input type="checkbox" class="custom-control-input" [(ngModel)]="cpT99453"
                id="cpt1">
              <label class="custom-control-label" for="cpt1">CPT 99453</label>
            </div>
            <div *ngIf="orderDetailObj?.order">
              <span *ngIf="orderDetailObj?.order['oStatus'] == 'In Process'" style="min-width: 80px;" class="badge px-3 badge-primary m-0 mr-2">
                {{orderDetailObj?.order['oStatus']}}
              </span>
              <span *ngIf="orderDetailObj?.order['oStatus'] == 'Cancelled'" style="min-width: 80px;" class="badge px-3 badge-danger m-0 mr-2">
              {{orderDetailObj?.order['oStatus']}}
              </span>
            <span *ngIf="orderDetailObj?.order['oStatus'] == 'Closed'" style="min-width: 80px;" class="badge px-3 badge-warning m-0 mr-2">
              {{orderDetailObj?.order['oStatus']}}
            </span>
            </div>
          </div>
          <div>
            <button type="button" class="btn btn-dynamic-secondary-2c btn-sm m-0 " aria-label="Close" (click)="viewOrderDetailModal.hide()">
              Close
            </button>
          </div>
          <!-- <button type="button" class="btn btn-dynamic-2c btn-md m-0">Save changes</button> -->

      </div>
    </div>
  </div>
</div>

<div mdbModal #orderReceiveConfirmModal="mdbModal" class="modal fade" tabindex="-1" role="dialog"
  aria-labelledby="myBasicModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <!-- <button type="button" class="close pull-right" aria-label="Close" (click)="orderReceiveConfirmModal.hide()">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="modal-title w-100" id="myModalLabel"><i class="fa fa-exclamation-triangle yellow-text"></i>{{modalObj.Title}}
        </h4> -->
        <h4 class="modal-title w-100 text-center" id="myModalLabel">Order Recieved
        </h4>
      </div>
      <div class="modal-body">
        <!-- {{modalObj.Text}} -->
        <!-- <div class="row"> -->

          <p class="text-center"><i class="fa fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i> </p>
          <div class="text-center">
            Do you want to mark this order as Received ?
          </div>
        <!-- </div> -->
        <div class="row" *ngIf="alreadyPendingBillingMsg">
          <div class="col-sm-12">

            <div class="alert alert-danger" role="alert">

              <p class="mb-0" style="font-size: 14px;">
                {{alreadyPendingBillingMsg}}
              </p>
            </div>

          </div>
        </div>


      </div>
      <!-- <div class="modal-footer" [class.justify-content-between]="preserverOrder.customerType===CustomerTypeEnum.Patient">
        <div class="d-flex align-items-center mb-2" *ngIf="preserverOrder.customerType===CustomerTypeEnum.Patient">
          <div class="custom-control custom-checkbox w-info-90">
            <input type="checkbox" class="custom-control-input" [(ngModel)]="cpT99453"
              id="cpt1">
            <label class="custom-control-label" for="cpt1">CPT 99453</label>
          </div>
        </div>
        <div>
          <button (click)="orderReceiveConfirmModal.hide()" type="button" mdbBtn color="secondry" class="waves-light btn-sm" aria-label="Close"
           mdbWavesEffect>No</button>
           <button type="button" [disabled]="gettingClaimDetail"
             (click)="ReceiveOrder()" mdbBtn color="primay" class="waves-light btn-sm" aria-label="Close"
           mdbWavesEffect>Yes</button>
        </div>
      </div> -->
    </div>
  </div>
</div>

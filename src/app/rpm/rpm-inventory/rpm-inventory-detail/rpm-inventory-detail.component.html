<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="d-flex align-items-center justify-content-start">
    <h4 class="mr-3 mb-0"><a class="text-dark" (click)="navigateBack()"><i class="fa fa-arrow-left"></i></a></h4>
    <h1 class="page-title mb-0">{{titleAppend}}RPM Inventory Detail</h1>
  </div>
  <div>
    <div class="d-inline-flex">
      <div *hasClaim="['IsAppAdmin']">
        <ng-select [(ngModel)]="selectedFacility" [clearable]="false"  [searchable]="true"  class="ng-select-small" placeholder="Select Facility" style="min-width:200px" (change)="changeFacility($event)">
          <ng-option [value]="-1">All</ng-option>
          <ng-option [value]="0">2C Inventory</ng-option>
          <ng-option [value]="facility.id" *ngFor="let facility of facilityList">{{facility.facilityName}}</ng-option>
        </ng-select>
      </div>

    </div>
    <!-- <button *ngIf="facilityId==0 && selected.length > 0" type="button" class="btn btn-dynamic-2c btn-sm mr-0" (click)="saleSelectedDevices(DeviceSaleRef)"
        placement="left">Sale Devices</button> -->
  </div>
</div>
<div class="row d-flex mb-3">
  <div class="d-flex align-items-end col-lg-12 col-sm-12">
    <div class="flex-grow-1">
      <label for="searchBy">Search</label>
      <div class="d-flex align-items-center justify-content-start">
        <input type="text" [(ngModel)]="searchStr" #searchPatient autocomplete="off" appOnDebounce [debounceTime]="1000"
          (onDebounce)="FilterDevices()" class="form-control form-control-sm box-shadow w-100" id="searchBy"
          [placeholder]="'Model / Serial No. / IMEI'+ placeHolder" />
      </div>
    </div>
    <!-- <button type="button" class="btn btn-dynamic-2c btn-sm my-0 flex-shrink-0 mr-0">
        Search
    </button> -->
  </div>
</div>
<div class="d-flex justify-content-between align-items-center">

  <div class="dataTables_length" id="example_length"><label>Show
      <select name="example_length" aria-controls="example" [(ngModel)]="pageSize" class="">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select> entries</label>
    </div>
    <button *ngIf="rpmDevicesList.length" title="Download Excel"type="button" (click)="MakeExcel()" class="btn btn-dynamic-2c btn-sm flex-shrink-0"><i
      class="fa fa-download fa-lg"></i> Download</button>
</div>
<div *ngIf="gettingFilteredDevices" class="d-flex justify-content-center text-center">
  <!-- <div class="d-flex justify-content-center text-center"> -->
  <mdb-progress-bar class="progress primary-color-dark mb-0" mode="indeterminate"></mdb-progress-bar>
</div>
<div class="mt-0">
  <ngx-datatable #myTable class="material fullscreen" [columnMode]="'force'" [headerHeight]="50" [footerHeight]="40"
    [rowHeight]="40" [scrollbarV]="false" [rows]="rpmDevicesList" [limit]="pageSize" [offset]="0"
    [count]="rpmDevicesList?.length" [loadingIndicator]="gettingFilteredDevices" [scrollbarH]="true">
    <ngx-datatable-column name="#" width=50>
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        {{rowIndex + 1}}
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column *ngIf="criteria!=='inhand'" prop="patientName" name="Patient Name">
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <div class="d-flex justify-content-between align-items-center">
          <div style="width:150px ;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
            {{row.patientName}}
          </div>
        </div>
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column prop="modalityName" name="Modality Name">
    </ngx-datatable-column>
    <ngx-datatable-column *ngIf="facilityId==0" [width]="50" [sortable]="false" [canAutoResize]="false" [draggable]="false"
      [resizeable]="false">
      <ng-template ngx-datatable-header-template let-value="value" let-allRowsSelected="allRowsSelected"
        let-selectFn="selectFn">
        <div class="text-center">
          <div class="custom-control custom-checkbox">
            <input class="custom-control-input" type="checkbox" id="selectAll" [(ngModel)]="gridCheckAll"
              (click)="gridAllRowsCheckBoxChecked($event)">
            <label class="custom-control-label" for="selectAll"></label>
          </div>
        </div>
      </ng-template>

      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <div class="text-center" style="width: 35px;">
          <div class="custom-control custom-checkbox">
            <input class="custom-control-input" type="checkbox" id="{{(row.id)}}cl" [(ngModel)]="row.checked"
              (click)="rowCheckBoxChecked($event, row)">
            <label class="custom-control-label" for="{{(row.id)}}cl"></label>
          </div>
        </div>
      </ng-template>

    </ngx-datatable-column>
    <ngx-datatable-column prop="status" name="Status" [width]="80">
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <!-- <span class="badge badge-success">{{PHDeviceStatusObj[row.status]}}</span>
        <span class="badge badge-danger">{{PHDeviceStatusObj[row.status]}}</span> -->
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small (click)="ConfirmStatusChange(row)" class="badge badge-success cursor-pointer"
            *ngIf="row.status == PHDeviceStatusObj.Active">Active</small>
            <small (click)="ConfirmStatusChange(row)" class="badge badge-danger cursor-pointer"
            *ngIf="row.status == PHDeviceStatusObj.InActive">Inactive</small>
          </div>
          <div class="d-inline-flex">
            <ng-container  *ngIf="criteria === 'issued' && !isAppAdmin">
              <div *hasClaim="['CanModifyInventory']">
                <button title="Move to Inhand" class="btn btn-dynamic-2c btn-icon"
                  (click)="OpenReturnDeviceModal(DeviceReturnCMPRef, row)"><i class="fa fa-share mr-0"
                    style="transform: rotate( 180deg);"></i></button>
              </div>
            </ng-container>
            <ng-container *ngIf="criteria === 'inhand' && !isAppAdmin">
              <button *hasClaim="['CanModifyInventory']" (click)="OpenIssueDeviceModal(DeviceIssueCMPRef, row)"
                title="Issue Device" class="btn btn-dynamic-2c btn-icon">
                <i class="fa fa-share"></i>
              </button>
            </ng-container>
          </div>
        </div>


      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column prop="place" name="Place" [width]="80">
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <span class="badge badge-info">{{row.place}}</span>
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="Info">
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <button class="btn btn-dynamic-2c btn-icon"
          (click)="openDeviceHistoryModal(row, RpmDeviceHistoryCMPRef, RpmDeviceHistoryModal)" title="Device History"><i
            class="fa fa-history"></i></button>
        <button *ngIf="showDeviceSaleDetailsIcon" class="btn btn-dynamic-2c btn-icon" (click)="openDeviceSaleDetailModal(row.id, deviceSaleDetailModal)"
          title="Device Sale Detail"><i class="fa fa-shopping-cart"></i></button>
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="Action" *ngIf="criteria === 'inhand'">
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <div class="d-flex">
          <!-- <ng-container *ngIf="isAppAdmin && facilityId == 0">
            <button title="Sale Device" class="btn btn-dynamic-2c btn-icon"
              (click)="OpenSaleDeviceModal(DeviceSaleRef, row)"><i class="fa fa-shopping-cart mr-0"></i></button>
          </ng-container> -->

          <div *ngIf="criteria === 'inhand'">
            <ng-container *ngIf="facilityId != 0">
              <ng-container *ngIf="row.status == PHDeviceStatusObj.InActive"  >
                <button *hasClaim="['CanModifyInventory']" (click)="OpenTransferDeviceModal(DeviceTransferCMPRef, row)"
                  title="Transfer Device" class="btn btn-dynamic-2c btn-icon mr-0">
                  <i class="fa fa-exchange" style="line-height: 35px;
                  margin-right: 3px;"></i>
                </button>
              </ng-container>
            </ng-container>
          </div>
          <ng-container *ngIf="criteria==='inhand'">
            <button *hasClaim="['CanModifyInventory' && 'IsFacilityUser']" (click)="OpenDisposeDeviceModal(DeviceDisposeCMPRef, row)"
              title="Dispose Device" class="btn btn-danger btn-icon">
              <i class="fa fa-trash"></i>
            </button>
          </ng-container>
        </div>
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column prop="installationDate" name="Installation Date">
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <span>{{row.installationDate | dateFormatPipe}}</span>
      </ng-template>
    </ngx-datatable-column>


    <ngx-datatable-column prop="model" name="Model">
    </ngx-datatable-column>
    <ngx-datatable-column prop="remainingInstallmentsCount" name="Installments Count">
    </ngx-datatable-column>
    <ngx-datatable-column prop="remainingInstallmentsAmount" name="Installments Amount">
    </ngx-datatable-column>
    <ngx-datatable-column prop="serialNo" name="Serial No">
    </ngx-datatable-column>
    <!-- <ngx-datatable-column  name="Action" [width]="60">
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>

      </ng-template>
    </ngx-datatable-column> -->
    <ngx-datatable-column prop="macDisplay" name="Mac">
    </ngx-datatable-column>






  </ngx-datatable>
</div>


<app-rpm-device-issue #DeviceIssueCMPRef (ReloadInventory)="ApplyInitCriteria()"></app-rpm-device-issue>
<app-rpm-device-dispose #DeviceDisposeCMPRef (ReloadInventory)="ApplyInitCriteria()"></app-rpm-device-dispose>
<app-rpm-device-return #DeviceReturnCMPRef (ReloadInventory)="ApplyInitCriteria()"></app-rpm-device-return>
<app-rpm-device-transfer #DeviceTransferCMPRef (ReloadInventory)="ApplyInitCriteria()"></app-rpm-device-transfer>
<app-sale-device #DeviceSaleRef (ReloadInventory)="ApplyInitCriteria()"></app-sale-device>


<div mdbModal #RpmDeviceHistoryModal="mdbModal" class="modal fade bottom" tabindex="-1" role="dialog"
  aria-labelledby="addDepartmentLabel" aria-hidden="true" [config]="{backdrop: true, ignoreBackdropClick: true}">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">

    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close pull-right" aria-label="Close" (click)="RpmDeviceHistoryModal.hide() ">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="modal-title w-100" id="myModalLabel">Device History</h4>
      </div>

      <div class="modal-body">
        <app-rpm-device-history #RpmDeviceHistoryCMPRef></app-rpm-device-history>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark btn-sm" aria-label="Close"
          (click)="RpmDeviceHistoryModal.hide()">Close</button>
      </div>
    </div>
  </div>
</div>
<div mdbModal #deviceSaleDetailModal="mdbModal" class="modal fade bottom" tabindex="-1" role="dialog"
  aria-labelledby="addDepartmentLabel" aria-hidden="true" [config]="{backdrop: true, ignoreBackdropClick: true}">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">

    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close pull-right" aria-label="Close" (click)="deviceSaleDetailModal.hide() ">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="modal-title w-100" >Device Sale Detail</h4>
      </div>

      <div class="modal-body" *ngIf="selectedDeviceId">
        <app-device-sale-detail #deviceSaleDetailRef [deviceId]="selectedDeviceId"></app-device-sale-detail>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark btn-sm" aria-label="Close"
          (click)="deviceSaleDetailModal.hide()">Close</button>
      </div>
    </div>
  </div>
</div>
<app-sale-device #DeviceSaleRef ></app-sale-device>

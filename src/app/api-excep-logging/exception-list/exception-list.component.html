<div class="d-flex flex-row align-items-center justify-content-between mb-3">
  <div>
    <h1 class="page-title mb-0">Exceptions</h1>
  </div>
  <!-- <div>
    <div class="action-button">
      <button [disabled]=updatingQBPaymentStatus class="btn btn-dynamic-2c btn-sm" (click)="UpdateInvoicesPaymentStatus()"
        title="Sync Quick Books Data">
        <span *ngIf="updatingQBPaymentStatus" class="spinner-border spinner-border-sm" role="status" aria-hidden="true">
        </span>
        <i class="fa fa-sync-alt fa-lg"></i> Sync QB Data</button>
    </div>
  </div> -->
</div>
<div class="justify-content-center pt-3 bg-white" style="border-radius: 5px;" *ngIf="historySummary?.week">
  <div class="row px-3">

      <div class="col-xl-3 col-lg-3 col-md-3 col-sm-3" title="Error APIs Count">
        <div class="border rounded p-2 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="title mb-0" ><strong>Error APIs</strong></h1>
            <p class="mb-0 number-title"><span >{{historySummary.apisCount}}</span></p>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-lg-3 col-md-3 col-sm-3" title="Last 24 hours count">
        <div class="border rounded p-2 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="title mb-0" ><strong>Today</strong></h1>
            <p class="mb-0 number-title"><span >{{historySummary.today}}</span></p>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-lg-3 col-md-3 col-sm-3" title="Last 3 days count">
        <div class="border rounded p-2 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="title mb-0" ><strong>3 Days</strong></h1>
            <p class="mb-0 number-title"><span >{{historySummary.last3days}}</span></p>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-lg-3 col-md-3 col-sm-3" title="Last 7 days count">
        <div class="border rounded p-2 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="title mb-0" ><strong>Week</strong></h1>
            <p class="mb-0 number-title"><span >{{historySummary.week}}</span></p>
          </div>
        </div>
      </div>
  </div>
</div>
<div class="row mt-3">
  <div class="col-lg-3" *ngFor="let item of displayInvoiceObj1">
    <div class="panel">
      <div class="panel-header p-2 border-bottom-0">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <small>Path</small>
            <p title="{{item.key}}" class="mb-0 font-500">{{item.key | slice:0:40}} <small> </small></p>
          </div>
          <div class="text-right">
            <small>Count</small>
            <p class="mb-0 text-dynamic-2c"><strong>
              <!-- {{item.value.length}} x {{item['unitPrice']}} = -->
                {{item.moduleTotal}}</strong></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- <div class="row">
  <div class="col-lg-6 col-sm-12">
    <label>Organization<small class="text-danger">*</small></label>
    <div class="form-group">
      <ng-select class="ng-select-small" [(ngModel)]="OrganizationId" name="myOrganization" [loading]="IsLoadingORG"
        [multiple]="false" [searchable]="true" (ngModelChange)="facilityId=null;getFacilitiesbyOrgId()"
        placeholder="Select Organization" required #IssueOrganizationid="ngModel" [ngClass]="{ 'is-invalid':(IssueOrganizationid.touched ||
      IssueOrganizationid.dirty) &&
      !IssueOrganizationid.valid }">
        <ng-option [value]="item.id" *ngFor="let item of organizationList">{{item.name}}</ng-option>
      </ng-select>
      <div *ngIf="IssueOrganizationid.invalid && (IssueOrganizationid.dirty || IssueOrganizationid.touched)"
        class="invalid invalid-text">
        <div *ngIf="IssueOrganizationid.errors['required']">
          <small class="text-danger">Please Select Oraganization.</small>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6 col-sm-12">
    <div class="form-group">
      <label for="Facilities">Facilities<small class="text-danger">*</small></label>
      <ng-select class="ng-select-small" name="myFacilities" [(ngModel)]="facilityId" [disabled]="!OrganizationId"
        [loading]="IsLoadingFC" [multiple]="false" [searchable]="true" (ngModelChange)="getInvoicesList()"
        placeholder="Select Facility" required #IssueFacility="ngModel" [ngClass]="{ 'is-invalid':(IssueFacility.touched ||
      IssueFacility.dirty) &&
      !IssueFacility.valid }">
        <ng-option [value]="0">All</ng-option>
        <ng-option [value]="item.id" *ngFor="let item of facilityList">{{item.facilityName}}</ng-option>
      </ng-select>
      <div *ngIf="IssueFacility.invalid && (IssueFacility.dirty || IssueFacility.touched)" class="invalid invalid-text">
        <div *ngIf="IssueFacility.errors['required']">
          <small class="text-danger">Please Select Facility Name.</small>
        </div>
      </div>
    </div>
  </div>
</div> -->

<div class="row mb-4">
  <!-- <div class="col-lg-4 col-sm-12">
    <div class="form-group">
      <label for="namea">Select Facility</label>
      <ng-select class="ng-select-small" [multiple]="false"
        [searchable]="true" [loading]="LoadingData" placeholder="Filter By Facility">
        <ng-option [value]="0">All</ng-option>
      </ng-select>
    </div>
  </div> -->
  <!-- <div class="col-lg-4 col-sm-12">
    <div class="form-group">
      <label for="namea">Select Month</label>
      <ng-select class="ng-select-small" [multiple]="false"
        [searchable]="true" [loading]="LoadingData" placeholder="Filter By Month">
        <ng-option [value]="0">All</ng-option>
        <ng-option [value]="1">January</ng-option>
        <ng-option [value]="2">February</ng-option>
        <ng-option [value]="3">March</ng-option>
        <ng-option [value]="4">April</ng-option>
        <ng-option [value]="5">May</ng-option>
        <ng-option [value]="6">June</ng-option>
        <ng-option [value]="7">July</ng-option>
        <ng-option [value]="8">August</ng-option>
        <ng-option [value]="9">September</ng-option>
        <ng-option [value]="10">October</ng-option>
        <ng-option [value]="11">November</ng-option>
        <ng-option [value]="12">December</ng-option>
      </ng-select>
    </div>
  </div> -->
</div>
<form autocomplete="off" class="mb-1">
  <div class="form-group">
    <label for="searchByFacility">Search Exception</label>
    <input type="text" class="form-control form-control-sm box-shadow" autocomplete="off" id="searchByFacility"
      placeholder="Search by Id" (keyup)="updateFilter($event)" />
  </div>
</form>
<div class="table-data-list">
  <div *ngIf="isLoadingExceptions" class="d-flex justify-content-center text-center">
    <mdb-progress-bar class="progress primary-color-dark mb-0" mode="indeterminate"></mdb-progress-bar>
  </div>
  <ngx-datatable #table class="material" appRecalculateNgxTable  [headerHeight]="50"
    [footerHeight]="50" [rowHeight]="40" [count]="rows.length" [scrollbarV]="false" [scrollbarH]="true"
    [rows]="rows" [offset]="0" [limit]="20">
    <ngx-datatable-column name="#" maxWidth=30>
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        {{rowIndex + 1}}
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="Id" prop="id" maxWidth=80>
    </ngx-datatable-column>
    <ngx-datatable-column name="Path" width=300>
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        <span class="text-dynamic-2c">{{row.httpMethod}}</span> {{ row.path }}
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="Client" prop="clientType" width=100>
    </ngx-datatable-column>
    <ngx-datatable-column name="Page Path" prop="pagePath" width=300>
    </ngx-datatable-column>
    <!-- <ngx-datatable-column name="Method" prop="eventName" >
    </ngx-datatable-column> -->
    <ngx-datatable-column name="LogTime" maxWidth=160>
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        {{ row.logTime | dateFormatPipe: 'time' }}
      </ng-template>
    </ngx-datatable-column>
    <!-- <ngx-datatable-column name="Status" prop="invoiceStatus"  [width]="150">
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        <div style="width: 130px;">
          <mdb-badge pill="true" success="true" color="w-100">{{row.invoiceStatus}}</mdb-badge>
        </div>
      </ng-template>
    </ngx-datatable-column> -->
    <ngx-datatable-column name="User" prop="loggedUser">
    </ngx-datatable-column>
    <!-- <ngx-datatable-column name="Query" prop="queryString">
    </ngx-datatable-column> -->
    <!-- <ngx-datatable-column name="Adjustment" prop="totalAdjAmount" [maxWidth]=150>
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        {{ row.requestBody }}
      </ng-template>
    </ngx-datatable-column> -->
    <ngx-datatable-column name="Message" prop="exceptionMessage" width=250>
    </ngx-datatable-column>
    <!-- <ngx-datatable-column name="Modal State" >
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        {{ row.modelState }}
      </ng-template>
    </ngx-datatable-column> -->
    <!-- <ngx-datatable-column name="BIlling Provider" prop="billingProvider" [maxWidth]=150>
    </ngx-datatable-column>
    <ngx-datatable-column name="Facility" prop="facilityName">
    </ngx-datatable-column> -->
    <ngx-datatable-column name="Action"  >
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <div class="action-button d-flex justify-content-center">
          <button class="btn btn-dynamic-2c btn-icon" title="View" (click)="openViewExceptionModal(viewExceptionDetailModal, row)" placement="left"><i
              class="fa fa-eye"></i></button>
              <button [disabled]="row['loading']" (click)="TryApi(row)" class="btn btn-info btn-icon" title="Retry" placement="left">
                <span *ngIf="row['loading']" class="spinner-border spinner-border-sm" role="status" aria-hidden="true">
                </span>
                <i class="fa fa-refresh"></i></button>
                <button class="btn btn-danger btn-icon" title="Delete" (click)="deleteException(row.id)" placement="left"><i
                    class="fa fa-trash"></i></button>
        </div>
      </ng-template>
    </ngx-datatable-column>
  </ngx-datatable>
</div>
<div style="overflow-y: auto" mdbModal #viewExceptionDetailModal="mdbModal" class="modal fade" role="dialog"
  [config]="{ignoreBackdropClick: true}" (close)="ExceptionModalCosed()" aria-labelledby="myBasicModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-xlx flat-modal" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close pull-right" aria-label="Close" (click)="viewExceptionDetailModal.hide()">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="modal-title pr-4 w-100"> Exception Detail </h4>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>Client:</span> {{ViewExceptionObj.clientType}}</div>
          </div>
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>Page Path:</span> {{ViewExceptionObj.pagePath}}</div>
          </div>
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>Type:</span> {{ViewExceptionObj.httpMethod}}</div>
          </div>
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>LogTime:</span> {{ViewExceptionObj.logTime}}</div>
          </div>
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>User:</span> {{ViewExceptionObj.loggedUser}}</div>
          </div>
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>Facility:</span> {{ViewExceptionObj.facilityName}}</div>
          </div>
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>Path:</span> {{ViewExceptionObj.path}}</div>
          </div>
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>Query String:</span> {{ViewExceptionObj.queryString}}</div>
          </div>
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>Model State:</span> {{ViewExceptionObj.modelState}}</div>
          </div>
          <div class="col-sm-6">
            <div class="modal-custom-text"> <span>Request Body:</span> {{ViewExceptionObj.requestBody}}</div>
          </div>
          <div class="col-sm-12">
            <div class="modal-custom-text"> <span>Inner Exception Message:</span> {{ViewExceptionObj.innerExceptionMessage}}</div>
            <div class="modal-custom-text"> <span>Exception Message:</span> {{ViewExceptionObj.exceptionMessage}}</div>
            <div class="modal-custom-text"> <span>Exception Stack Trace:</span>
              <div id="exceptionStackTraceRef">
                <!-- {{ViewExceptionObj.exceptionStackTrace}} -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark btn-sm" aria-label="Close" (click)="viewExceptionDetailModal.hide();"
          mdbWavesEffect>Close</button>
      </div>
    </div>
  </div>
</div>

<div class="d-flex align-items-center justify-content-between flex-wrap mb-3">
  <h1 class="page-title mb-0 flex-sm-grow-1 mb-3">
    <a class="text-dark" [routerLink]="['/accounts/invoices']">
      <i class="fa fa-arrow-left"></i>
    </a>
    Invoice Reconciliation <span *ngIf="invoiceNumber" class="text-dynamic-2c">- {{invoiceNumber}}</span>
  </h1>
</div>
<div class="d-flex align-items-start">
  <div class="flex-grow-1">
    <!-- <label for="searchBy">Search Patient</label> -->
    <div class="d-flex align-items-center justify-content-start">
      <input type="text" #searchPatient autocomplete="off" class="form-control form-control-sm box-shadow w-100"
        id="searchBy" id="searchByFacility" (keyup)="updateFilter($event)"
        placeholder="Search by Name / Emr Id / Cpt Code" />
    </div>
  </div>
  <div>
    <button type="button" class="btn btn-dynamic-2c btn-sm my-0 flex-shrink-0 mr-0" appDebounceClick
      (debounceClick)="home.toggle()"><i class="fa fa-filter fa-lg"></i>
      Filter</button>
    <button type="button" (click)="resetFilters()" class="btn btn-dynamic-secondary-2c btn-sm my-0 flex-shrink-0"><i
        class="fa fa-refresh fa-lg"></i> Reset</button>
    <button type="button" (click)="MakeExcel()" class="btn btn-dynamic-2c my-0 ml-0 btn-sm flex-shrink-0"><i
        class="fa fa-download fa-lg"></i> Download</button>
  </div>

</div>
<div class="search-filter collapseable" mdbCollapse #home="bs-collapse">
  <div class="panel mt-3" style="overflow: visible;">
    <div class="panel-header d-flex justify-content-between align-items-center">
      <h3>Search Filter</h3>
      <div>
        <button type="button" class="close pull-right" aria-label="Close" (click)="home.hide()">
          <span aria-hidden="true">×</span>
        </button>
      </div>
    </div>
    <div class="panel-body">
      <div class="row ">
        <div class="col-xl-3 col-lg-6 col-sm-6">
          <div class="form-group">
            <label for="namee">CPT Code</label>
            <ng-select class="ng-select-small" id="measure" [(ngModel)]="filterInvoiceDto.cptCode" [searchable]="false" (ngModelChange)="fillCptCodeFilterValue()" (add)="filterCptCode($event)"
              [multiple]="false" placeholder="Select CPT Code" [closeOnSelect]="false" [multiple]="true">
              <ng-option [value]="''">All</ng-option>
              <ng-container *ngFor="let cpt of cptCargesList">
                <ng-option [value]="cpt.cptCode">{{cpt.cptCode}}</ng-option>
              </ng-container>
            </ng-select>
          </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-sm-6">
          <div class="form-group">
            <div class="form-group mb-0">
              <label for="Service-Date">Service Date</label>
              <input *ngIf="showAssignDateField" id="assignedDateField"
                class="form-control form-control-sm box-shadow w-100" type="text" autocomplete="nope"
                [(ngModel)]="selectedDateRange" name="daterangeInput" daterangepicker [options]="options"
                (selected)="selectedDate($event, daterange)" placeholder="Date"
                (cancelDaterangepicker)="clearDate();clearDatePickerSelection()" />
              <input *ngIf="!showAssignDateField" id="assignedDateField"
                class="form-control form-control-sm box-shadow w-100" type="text" autocomplete="nope"
                [(ngModel)]="selectedDateRange" name="daterangeInput" daterangepicker [options]="options"
                (selected)="selectedDate($event, daterange)" placeholder="Date"
                (cancelDaterangepicker)="clearDate();clearDatePickerSelection()" />
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-sm-6">
          <div class="form-group">
            <label for="PatientS">Payment</label>
            <ng-select [multiple]=true appendTo="body" [(ngModel)]="filterInvoiceDto.paymentMode" [searchable]="false"
              class="ng-select-small" placeholder="Patient Status" [closeOnSelect]="true" (ngModelChange)="fillPaymentFilterValue()" (add)="filterPayment($event)">
              <ng-container>
                <ng-option [value]="-1">All</ng-option>
                <ng-option *ngFor="let item of paymentEnumList" [value]="item.value">{{item.name}}</ng-option>
              </ng-container>

            </ng-select>
          </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-sm-6">
          <div class="form-group">
            <label for="PatientS">Case Status</label>
            <ng-select [multiple]="false" appendTo="body" [(ngModel)]="filterInvoiceDto.caseStatus" [searchable]="false"
              class="ng-select-small" placeholder="Patient Status" [closeOnSelect]="true" [clearable]="false">
              <ng-container>
                <ng-option [value]="-1">All</ng-option>
                <ng-option *ngFor="let item of caseStatusEnumList" [value]="item.value">{{item.name}}</ng-option>
              </ng-container>
            </ng-select>
          </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-sm-6">
          <div class="form-group">
            <label for="PatientS">Payment Status</label>
            <ng-select [multiple]="false" appendTo="body" [(ngModel)]="filterInvoiceDto.paymentStatus"
              [searchable]="false" class="ng-select-small" placeholder="Patient Status" [closeOnSelect]="true"
              [clearable]="false">
              <ng-container>
                <ng-option [value]="-1">All</ng-option>
                <ng-option *ngFor="let item of paymentStatusEnumList" [value]="item.value">{{item.name}}</ng-option>
              </ng-container>

            </ng-select>
          </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-sm-6">
          <div class="form-group">
            <label for="PatientS">Patient Responsibility Type</label>
            <ng-select [multiple]="false" appendTo="body" [(ngModel)]="filterInvoiceDto.patientResponseType"
              [searchable]="false" class="ng-select-small" placeholder="Patient Status" [closeOnSelect]="true"
              [clearable]="false">
              <ng-container>
                <ng-option [value]="-1">All</ng-option>
                <ng-option *ngFor="let item of patientResponseTypeEnumList" [value]="item.value">{{item.name}}
                </ng-option>
              </ng-container>

            </ng-select>
          </div>
        </div>
        <div class="col-xl-6 col-lg-6 col-sm-6 text-right">
          <div class="btn-group" style="    padding-top: 1.85rem;">
            <button type="button" (click)="setPage()" class="btn btn-dynamic-2c btn-sm my-0 flex-shrink-0">
              <i class="fa fa-filter fa-lg"></i>
              Search
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="dataTables_length mt-3" id="example_length">
  <label class="mb-0">Show
  <select name="example_length" aria-controls="example" [(ngModel)]="pageSize" class="">
    <option value="10">10</option>
    <option value="25">25</option>
    <option value="50">50</option>
    <option value="100">100</option>
  </select> entries</label>
</div>
<div class="table-data-list">
  <div *ngIf="isLoading" class="d-flex justify-content-center text-center">
    <mdb-progress-bar class="progress primary-color-dark mb-0" mode="indeterminate"></mdb-progress-bar>
  </div>
  <ngx-datatable class="material" [columnMode]="'force'" [headerHeight]="50" [footerHeight]="50" [rowHeight]="40"
    [externalPaging]="false" [count]="pagingData.elementsCount" [scrollbarV]="false" [scrollbarH]="true" [rows]="rows"
    [limit]="pageSize">
    <ngx-datatable-column name="#" width="30">
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        {{rowIndex + 1}}
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column  name="Action"  width="60">
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <div class="action-button d-flex justify-content-start">
          <button class="btn btn-dynamic-2c btn-icon" mdbTooltip="View"
            (click)="assignEncounterClaimValues(row)" placement="left"><i class="fa fa-pencil"></i></button>
        </div>
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="Name" prop="patientName" >
    </ngx-datatable-column>
    <ngx-datatable-column name="Emr Id" prop="patientEmrId" width="120">
    </ngx-datatable-column>
    <ngx-datatable-column name="CPT Code" prop="cptCode" width="80">
    </ngx-datatable-column>
    <ngx-datatable-column name="Service Date" prop="serviceDate" width="100">
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        {{row.serviceDate | dateFormatPipe}}
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="Case Status" prop="caseStatus" width="100">
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        <mdb-badge pill="true" info="true" color="info">{{InvoiceCaseStatusEnum[row.caseStatus]}}</mdb-badge>
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="PI" prop="primaryInsurancePayment" width="50">
      <ng-template ngx-datatable-header-template let-column="column">
        <span title="Primary Insurance Payment">PI</span>
     </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="SI" prop="secondaryInsurancePayment" width="50">
      <ng-template ngx-datatable-header-template let-column="column">
        <span title="Secondary Insurance Payment">SI</span>
     </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="PP" prop="patientPayment" width="50">
      <ng-template ngx-datatable-header-template let-column="column">
        <span title="Patient Payment">PP</span>
     </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="TP" prop="totalPayment" width="50">
      <ng-template ngx-datatable-header-template let-column="column">
        <span title="Total Payment">TP</span>
     </ng-template>
    </ngx-datatable-column>
    <!-- <ngx-datatable-column name="Pt. Resp." prop="patientResponseType">
        </ngx-datatable-column> -->
    <ngx-datatable-column name="Resp. Type" prop="patientResponseType" width="100">
      <ng-template ngx-datatable-header-template let-column="column">
        <span title="Patient Response Type">Resp. Type</span>
     </ng-template>
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        <mdb-badge pill="true" success="true" color="success">{{invoicePatientResponseTypeEnum[row.patientResponseType]}}</mdb-badge>
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="P Status" prop="paymentStatus" width="100">
      <ng-template ngx-datatable-header-template let-column="column">
        <span title="Payment Status">P Status</span>
     </ng-template>
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        <mdb-badge pill="true" info="true" color="info">{{paymentStatusEnum[row.paymentStatus]}}</mdb-badge>
      </ng-template>
    </ngx-datatable-column>
    <ngx-datatable-column name="Comments" prop="comments">
      <ng-template ngx-datatable-cell-template let-value="value" let-row="row" let-rowIndex="rowIndex">
        <p title="{{row.comments}}" style="margin: 0;
            white-space: nowrap;
            font-size: 12px;
            line-height: 12px;
            width: 120px;
            text-overflow: ellipsis;
            display: block;
            overflow: hidden;">{{row.comments}}</p>
      </ng-template>
    </ngx-datatable-column>
  </ngx-datatable>
</div>

<div mdbModal #encounterClaimsModal="mdbModal" class="modal fade" tabindex="-1" role="dialog"
  aria-labelledby="myBasicModalLabel" aria-hidden="true" [config]="{backdrop: false, ignoreBackdropClick: true}"
  (close)="clearEncounterClaimValues()">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close pull-right" aria-label="Close" (click)="encounterClaimsModal.hide()">
          <span aria-hidden="true">×</span>
        </button>
        <h4 class="page-title mb-0"><strong>Edit Encounter Claim </strong></h4>
      </div>
      <div class="modal-body">
          <fieldset>
            <div class="row">
              <div class="col-12">
                <div class="form-group">
                  <label>Case Status</label>
                  <ng-select [multiple]="false" appendTo="body" [(ngModel)]="encounterClaimDto.caseStatus"
                    [searchable]="false" class="ng-select-small" placeholder="Patient Status" [closeOnSelect]="true"
                    [clearable]="false">
                    <ng-container *ngFor="let item of caseStatusEnumList">
                      <ng-option [value]="item.value">{{item.name}}</ng-option>
                    </ng-container>
                  </ng-select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <div class="form-group">
                  <label>Patient Responsibility</label>
                  <ng-select [multiple]="false" appendTo="body" [(ngModel)]="encounterClaimDto.patientResponseType"
                    [searchable]="false" class="ng-select-small" placeholder="Patient Status" [closeOnSelect]="true"
                    [clearable]="false">
                    <ng-container *ngFor="let item of patientResponseTypeEnumList">
                      <ng-option [value]="item.value">{{item.name}}</ng-option>
                    </ng-container>
                  </ng-select>
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex align-items-center justify-content-start">
                  <div class="form-group  w-100">
                    <label>Payment Status</label>
                    <ng-select [multiple]="false" appendTo="body" [(ngModel)]="encounterClaimDto.paymentStatus"
                      [searchable]="false" class="ng-select-small" placeholder="Patient Status" [closeOnSelect]="true"
                      [clearable]="false">
                      <ng-container *ngFor="let item of paymentStatusEnumList">
                        <ng-option [value]="item.value">{{item.name}}</ng-option>
                      </ng-container>
                    </ng-select>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <div class="form-group">
                  <label>Primary Patient Insurance</label>
                  <input type="number" [(ngModel)]="encounterClaimDto.primaryInsurancePayment"
                    class="form-control form-control-sm box-shadow w-100" id="searchBy" />
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex align-items-center justify-content-start">
                  <div class="form-group  w-100">
                    <label>Secondary Patient Insurance</label>
                    <input type="number" [(ngModel)]="encounterClaimDto.secondaryInsurancePayment"
                      class="form-control form-control-sm box-shadow w-100" id="searchBy" />
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-6">
                <div class="form-group">
                  <label>Patient Payment</label>
                  <input type="number" [(ngModel)]="encounterClaimDto.patientPayment"
                    class="form-control form-control-sm box-shadow w-100" id="searchBy" />
                </div>
              </div>
              <div class="col-6">
                <div class="form-group">
                  <label>Comment</label>
                  <textarea class="form-control form-control-sm box-shadow w-100"
                    [(ngModel)]="encounterClaimDto.comments" name="comment" id="comment" cols="30" rows="5"></textarea>
                </div>
              </div>
            </div>
          </fieldset>
      </div>
      <div class="modal-footer">
          <button type="button" class="waves-light btn-sm btn btn-dynamic-secondary-2c" aria-label="Close"
            (click)="encounterClaimsModal.hide()" mdbWavesEffect>Close</button>
          <button type="button" [disabled]="isUpdatingEncounterClaim"
            class="relative waves-light btn btn-sm btn-dynamic-2c" mdbWavesEffect (click)="updateEncounterClaim()">
            <span *ngIf="isUpdatingEncounterClaim" class="spinner-border spinner-border-sm" role="status"
              aria-hidden="true"></span>
            Update</button>

      </div>
    </div>
  </div>
